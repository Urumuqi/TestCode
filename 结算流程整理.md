## 结算流程
- 符合结算的同的订单
    1. 订单支付金额 > 0 yuan
    3. ==渠道商运维==的门店[borrow_business_id]
    4. 订单借出时间在渠道商的运维周期内[订单开始时间start_time]
    5. 订单支付时间在结算周期内[订单结束时间return_time]
    6. 订单类型为==电池订单==
    7. 订单已结束 [status = 1 && step = 'finished' && payment_status = 1]
    8. 订单error_code IN (==108, 109==)不计入分成[电源报失,用户费用计算失败]

- 订单统计流程

    > 订单结束kafka消息

    1. 订单结束，并且用户支付完成
    2. 记录订单[订单号，订单金额，用户支付金额，门店，运维渠道商，订单开始时间，订单结束时间(或者订单支付时间)]
    6. 门店以小时分隔，统计每小时营收[最细粒度的门店数据]
    3. 门店按天统计门店总计营收[门店小时数据汇总]
    4. 渠道商以小时分隔，统计每小时的营收，由门店数据汇总[渠道商最细粒度营收数据]
    5. 渠道商每天营收汇总，生成每天的营收单

- 订单扣款流程

    >订单扣款kafka消息

    1. 订单产生扣款，并且扣款生效(用户实际支付金额发生改变)
    2. 记录扣款订单[原始订单，扣款订单]
    3. 门店扣款按小时维度汇总扣款订单
    4. 生成门店每天扣款单
    5. 将商家小时扣款数据汇总到渠道商小时扣款数据
    6. 将渠道商小时明细数据，汇总到渠道商每天的扣款单


- 生成每天的应付单

    > 应付单金额 = 付款单 - 扣款单

- 生成对账单

    > 按账期开始结束时间，将渠道商每天的应付单汇总，生成对账单

---

## 和原结算方案的差异

- 原始数据差异
    1. 新的表结构没有冗余门店和渠道商信息，门店和渠道商数据从CRM获取
    2. 表结构简化，页面展示字段会有所减少

- 用户功能影响点
    1. 渠道商应付单列表，应付单明细展示营收和扣款[应付金额 = 营收 - 扣款]
    2. 增加渠道扣款单列表，商家维度[商家每天扣款]
    3. 应付明细中原来的订单列表，变为商家明细列表

- 数据构造
    1. 保留目前的对账单审核流程，对账单上渠道商信息从CRM实时获取
    2. 商家明细列表， 商家信息从CRM实时获取

## 开发结点拆分

- 消费kafka，记录有效订单
- 通过订单生成商家每小时营收明细，扣款明细
-
